<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="theme-color" content="rgb(0 122 255)">

    <title>Chart</title>


    <!-- Required stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">


    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.5.0/chart.umd.js"
        integrity="sha512-D4pL3vNgjkHR/qq+nZywuS6Hg1gwR+UzrdBW6Yg8l26revKyQHMgPq9CLJ2+HHalepS+NuGw1ayCCsGXu9JCXA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

</head>

<body onload="buildTable(60)">


    <div class="container">
        <h1 class="mt-5">Server Request Histogram</h1>
        <div class="row">
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <button class="btn btn-outline-secondary" id="updateData" type="button">Update Data</button>
                </div>
                <input type="text" class="form-control" id="newStepSize" value="60s" aria-label=""
                    aria-describedby="basic-addon1">
            </div>
            <canvas id="myChart"></canvas>
        </div>
    </div>

</body>

<script>
    var myChart;

    function prettyDate(dt) {
        var seconds = (dt) / 1000;
        var d = Math.floor(seconds / (3600 * 24));
        var h = Math.floor(seconds % (3600 * 24) / 3600);
        var m = Math.floor(seconds % 3600 / 60);
        var s = Math.floor(seconds % 60);
        var ret = (d > 0 ? d + "d" : "") + (h > 0 ? h + "h" : "") + (m > 0 ? m + "m" : "") + (s > 0 ? s + "s" : "");
        ret = (ret == "" ? "0s" : ret);
        return ret;
    }


    function getSecs(str) {
        var d = 0,
            h = 0,
            min = 0,
            sec = 0;

        if (str.includes("d")) {
            d = str.split("d")[0];
            str = str.split("d")[1];
        }

        if (str.includes("h")) {
            h = str.split("h")[0];
            str = str.split("h")[1];
        }

        if (str.includes("m")) {
            min = str.split("m")[0];
            str = str.split("m")[1];
        }

        if (str.includes("s")) {
            sec = str.split("s")[0];
        } else {
            sec = str;
        }

        ret = Number(sec) + 60 * min + 3600 * h + 3600 * 24 * d;
        if (isNaN(ret) || ret <= 0) {
            ret = 60;
        }
        return ret;
    }


    document.getElementById("updateData").onclick = function() {
        var val = document.getElementById("newStepSize").value;
        val = getSecs(val);
        document.getElementById("newStepSize").value = prettyDate(val * 1000);
        buildTable(val);
    };


    function buildTable(step) {
        var histogram = {};
        var maxStep = 0;
        fetch('/log/server')
            .then(res => res.text())
            .then(d => {
                if (d==="You need to be logged in as admin to see this page") {
                    alert("Not Available")
                    return;
                }
                d = JSON.parse('[' + d.slice(0, -1) + ']');
                for (let i = 0; i < d.length; i++) {
                    var stepped = Math.floor(getSecs(d[i].at) / step);
                    maxStep = Math.max(maxStep, stepped);
                    (histogram[stepped.toString()]) ? histogram[stepped.toString()]++: histogram[stepped
                            .toString()] =
                        1;
                }
                for (let i = 0; i <= maxStep; i++) {
                    if (!histogram[i.toString()]) {
                        histogram[i.toString()] = 0;
                    }
                }
                var xValues = Object.keys(histogram);
                for (let i = 0; i < xValues.length; i++) {
                    xValues[i] = prettyDate(Number(xValues[i]) * step * 1000);
                }
                var yValues = Object.values(histogram);
                const ctx = document.getElementById('myChart');
                if (myChart) {
                    myChart.destroy();
                }
                myChart = new Chart(ctx, {
                    type: "bar",

                    data: {
                        labels: xValues,
                        datasets: [{
                            label: 'Number of requests',
                            fill: false,
                            lineTension: 0.3,
                            backgroundColor: "rgba(0,0,255,1.0)",
                            borderColor: "rgba(0,0,255,0.1)",
                            data: yValues
                        }]
                    }
                });
            });
    }





    // const xValues = [50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150];
    // const yValues = [7, 8, 8, 9, 9, 9, 10, 11, 14, 14, 15];
</script>

</html>